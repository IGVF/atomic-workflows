
manifest {
  description = 'A nexflow pipeline for fg single cell atac' 
  mainScript = 'nf_wf_fg_singlecell_atac.nf'
}

profiles {
  google_batch_profile {
    workDir = 'gs://eila-nextflow-bucket/work/ATAC'
    includeConfig 'conf/docker-google-batch.config'
    docker.enabled = true
    wave.enabled = true
    fusion.enabled = true
    process.scratch = false
    executor = 'google-batch'
    docker.envWhitelist=['ENV_SYNAPSE_TOKEN','TOWER_ACCESS_TOKEN']
    google.project = 'hai-gcp-genomic'
    google.location = 'us-central1'
    google.batch.spot = true
    google.batch.serviceAccountEmail='eila-batch@hai-gcp-genomic.iam.gserviceaccount.com'
  }
}

// Define ENV_SYNAPSE_TOKEN as a parameter
params.FASTQS_SPEC_CH = '/home/eila/git_igvf/atomic-workflows/nextflow/nf_data/wdl_atac_pipeline/vm_atac_fastqs_files.tsv'

// SEQSPEC
params.EXECUTE_SEQSPEC_MODIFY='seqspec_run_modify.sh'

// ZCAT
params.EXECUTE_ZCAT_SCRIPT='run_zcat.sh'

// GZIP:
params.EXECUTE_GZIP_SCRIPT='run_gzip.sh'

// BGZIP
params.EXECUTE_BGZIP_SCRIPT='run_bgzip.sh'

// CHROMAP SCRIPTS
params.CHROMAP_CREATE_INDEX_SCRIPT='run_chromap_index.sh'
params.CHROMAP_MAP_TO_INDEX='run_chromap_map_to_index.sh'
// 6a
params.CHROMAP_IDX='gs://eila-nextflow-bucket/test_atac_pipeline/ref.index'

// 6b:
// FASTA file
params.CHROMAP_READ_LENGTH = 2000
params.CHROMAP_BC_ERROR_THRESHOLD = 2
params.CHROMAP_BC_PROBABILITY_THRESHOLD = 0.9
params.CHROMAP_READ_FORMAT = 'bc:0:-1,r1:0:-1,r2:0:-1'
params.CHROMAP_DROP_REPETITIVE_READS = 4
params.CHROMAP_QUALITY_THRESHOLD = 0
params.CHROMAP_MERGE_LOGS_SCRIPT = "merge_chromap_logs.sh"
params.CHROMAP_FRAGMENTS_HISTOGRAM_DATA_SCRIPT='generate_insert_size_histogram_data.sh'
params.CHROMAP_GENOME_REFERENCE_FASTA='/home/eila/git_igvf/atomic-workflows/nextflow/nf_data/wdl_atac_pipeline/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.gz'

// CHROMAP DEBUG: load output files 
// params.chromap_filter_fragments_tsv ='/home/eila/git_igvf/atomic-workflows/nextflow/nf_data/wdl_atac_pipeline/chromap_out_debug/ATAC_BMMC-single-donor.atac.filter.fragments.tsv'
// params.barcode_summary_csv ='/home/eila/git_igvf/atomic-workflows/nextflow/nf_data/wdl_atac_pipeline/chromap_out_debug/BMMC-single-donor.atac.align.barcode.summary.csv'
// params.chromap_alignment_log_out = '/home/eila/git_igvf/atomic-workflows/nextflow/nf_data/wdl_atac_pipeline/chromap_out_debug/BMMC-single-donor.atac.align.k4.hg38.log.txt'

// CHROMAP WDL DEBUG: load output files 
params.chromap_fragments_tsv ='/home/eila/git_igvf/atomic-workflows/nextflow/nf_data/wdl_atac_pipeline/ATAC_BMMC-single-donor.atac.filter.fragments.tsv'
params.barcode_summary_csv ='/home/eila/git_igvf/atomic-workflows/nextflow/nf_data/wdl_atac_pipeline/BMMC-single-donor.atac.align.barcode.summary.csv'
params.chromap_alignment_log_out = '/home/eila/git_igvf/atomic-workflows/nextflow/nf_data/wdl_atac_pipeline/BMMC-single-donor.atac.align.k4.hg38.log.txt'
params.bgzip_subpool_chromap_fragments_tsv_out='/home/eila/git_igvf/atomic-workflows/nextflow/nf_data/wdl_atac_pipeline/BMMC-single-donor.atac.filter.fragments.hg38.tsv.gz'
params.no_singleton_gz='/home/eila/git_igvf/atomic-workflows/nextflow/nf_data/wdl_atac_pipeline/no-singleton.bed.gz'
// params.tbi_no_singleton_bed_gz_out='/home/eila/git_igvf/atomic-workflows/nextflow/nf_data/wdl_atac_pipeline/.tbi'

params.TSV_ADD_SUBPOOL_SCRIPT = 'add_subpool_to_chromap_output.sh'
params.CSV_ADD_SUBPOOL_SCRIPT = 'add_subpool_to_summary_file.sh'
params.FILTER_FRAGMENTS_SCRIPT = 'filter_fragments_gz_sort_bgzip_script.sh'
params.ATAC_FRAGMENTS_MIN_FRAG_CUTOFF=10

// Other steps

params.GENOME_GZ_GTF='http://ftp.ensembl.org/pub/release-109/gtf/homo_sapiens/Homo_sapiens.GRCh38.109.gtf.gz'
params.ENV_SYNAPSE_TOKEN = "nextflow secrets get SYNAPSE".execute().text.trim()


params.MAPQ_THRESHOLD = false
params.BARCODE_TRANSLATE = 'path'
params.ATAC_FRAGMENTS_CUTOFF = 4
params.RUN_TABIX_SCRIPT='run_tabix.sh'
params.ATAC_TSS_BASES_FLANK = 2000
params.ATAC_TSS_COL_WITH_STRANDS_INFO = 4
params.ATAC_TSS_SMOOTHING_WINDOW_SIZE = 20
params.ATAC_TSS_REGION_BED_FILE='/home/eila/git_igvf/atomic-workflows/nextflow/nf_data/wdl_atac_pipeline/hg38.refGene.TSS.bed'
params.ATAC_TSS_BULK_CALCULATION_SCRIPT='compute_tss_enrichment_bulk.py'
params.ATAC_TSS_SNAPATAC2_CALCULATION_SCRIPT='compute_tss_enrichment_snapatac2.py'
params.ATAC_TSS_SNAPATAC2_GENES_GTF='/home/eila/git_igvf/atomic-workflows/nextflow/nf_data/wdl_atac_pipeline/genes.gtf'
params.ATAC_TSS_SNAPATAC2_MIN_FRAG_CUTOFF = 10

params.ATAC_INSERT_SIZE_PLOT_SCRIPT='plot_insert_size_hist.py'
params.pkr_id="BMM_PKR_ID"

// atac calculate_barcode_metadata_stats
params.ATAC_SNAP_METADATA_STATS_SCRIPT='calculate_barcode_metadata_stats.sh'
// atac plot barcode metadata
params.ATAC_PLOT_METADATA_SCRIPT='atac_generate_metadata_barcode_rank_plot.R'
params.ATAC_PLOT_METADATA_HELPER_SCRIPT='barcode_rank_functions.R'

// debug file
// params.SC_ATAC_QC_BARCODE_METADATA_FILE='/home/eila/git_igvf/atomic-workflows/nextflow/nf_data/wdl_atac_pipeline/barcode_metadata.txt'
params.ATAC_QC_FRAGMENT_CUTOFF=10
params.SC_ATAC_QC_BARCODE_OUTPUT_FILE='atac_barcode_metadata_output_file.png'
    
// params.SC_ATAC_BARCODE_METADATA_SCRIPT='atac_generate_merged_barcode_metadata.sh'
// DEBUG: get the data from a file
// params.SC_ATAC_BARCODE_METADATA_FILTERED_BARCODE_STATS='/home/eila/git_igvf/atomic-workflows/nextflow/nf_datanf_wf_fg_singlecell/filtered_barcode_stats.csv'
// params.SC_ATAC_BARCODE_METADATA_TSS_ENRICHMENT_BARCODE_STATS='/home/eila/git_igvf/atomic-workflows/nextflow/nf_datanf_wf_fg_singlecell/tss_enrichment_barcode_stats.csv'

// params.SC_ATAC_GENERATE_BARCODE_RANK_PLOT_PKR='PKR123'

// params.SC_JOINT_CELL_BARCODE_PLOT_SCRTIP_PY='joint_cell_plotting.py'
// params.SC_JOINT_CELL_BARCODE_PLOT_SCRTIP_R='joint_cell_plotting_density.R'

// DEBUG

params.CPUS_TO_USE_TSS=16
params.CPUS_TO_USE_CHROMAP_IDX=32
